# 项目大总结（供新对话/新模型快速上手）by ChatGPT 

> 本总结**只依据本对话内你与我给出的事实**整理，**不引入外部文献细节**。所有口径、数值与判断均来自本次对话中你已执行的 Cypher 检查与反馈结果。  
> 目标：让新的 AI 立刻明白**我们已经导入了什么数据、数据长什么样**，以及**当前约定的模型架构与参数口径**（注明哪些是工程选择）。

---

## 1) 数据导入与检验结果

### 1.1 导入范围（简要过程）

- **核心层**：`Disease (ICD-11)`, `CPM`, `Herb (CHP)`, `Chemical`, `Target`
    
- **增强层**：
    
    - `TARGETS`（化合物→靶点，**实验证据**）
        
    - `TARGETS_PREDICTED`（化合物→靶点，**SD1 预测**）
        
    - `ASSOCIATED_WITH`（靶点→疾病，来源 **CUI** 与 **MeSH**）
        
    - `INTERACTS_WITH`（靶点↔靶点，**PPI**）
        
    - `HAS_PROPERTY`（Herb→药性/归经/类别，**D7**）
        
    - `sources`（Chemical 溯源属性数组，**D14**）
        
- **方剂实体化（我们新增）**：从 `CPM` 一一映射创建 `Formula` 节点，并复制 `CONTAINS` 到 `Formula`，以便下游“每个方剂一张子图”建模。
    
- **序列属性（我们补充）**：从 **D17** 将 `sequence_aa` 与 `seq_len` 写入 `Target`（去除换行），**覆盖率 100%**。
    
- **DOID 路径**（D21+D24）：**未导入**（A 检查中 `n_doid=0` 也印证了这一点）。
    

> 注：中途对 SD1 采用了**分批导入**与**汇总去重**；对大查询的统计采用了 **EXISTS 子查询** 以避免爆炸式中间结果。

---

### 1.2 关键计数与连通性（你已执行的检查结果）

#### A｜疾病 → 靶点 覆盖率

|指标|数值|解释|
|---|---|---|
|diseases_total|**17,692**|全部 ICD-11 疾病|
|n_cui|**247**（1.4%）|通过 CUI 有靶点的疾病|
|n_mesh|**1,614**（9.1%）|通过 MeSH 有靶点的疾病|
|n_doid|**0**|DOID 未导入/无数据|
|n_any|**1,684**（≈9.5%）|**至少**一种来源有靶点的疾病|

> 结论：**约 1.7k 疾病具备分子证据**（主来自 MeSH）；其余可作为冷启动/无分子信息集。

#### B｜疾病侧靶点分布（合并来源）

|指标|数值|
|---|---|
|最小值 min_k|**1**|
|中位数 p50|**2,347**|
|90 分位 p90|**17,638.7**|
|最大值 max_k|**19,252**|
|平均值 avg_k|**6,041.49**|
|有靶点的疾病数|**1,684**|

> 结论：**极端长尾且超稠密**（癌症/炎症类常见），训练前需 **top-K 截断/重加权**。

#### C｜靶点质量（序列 + PPI）

|指标|数值|备注|
|---|---|---|
|targets_total|**19,700**|靶点总数|
|with_seq / 覆盖率|**19,700 / 100%**|已导入 `sequence_aa`|
|seq 长度|min **2** / p50 **423** / p90 **1089** / max **32767**|个别极端值存在|
|PPI（孤点数）|**0**|全连通|
|PPI 度分布|p50 **552** / p90 **1447** / max **9230**|稠密合理|

> 结论：靶点层**质量最高**，可直接用于嵌入；极端序列可在 QC 中排除。

#### D｜化合物 → 靶点（实验 vs 预测）

|指标|数值|
|---|---|
|化合物总数|**125,187**|
|有实验靶点的化合物|**68,448（54.7%）**|
|有预测靶点的化合物|**62,830（50.2%）**|
|实验：每化合物靶点数|p50 **3** / p90 **134** / max **5,925**|
|预测：每化合物靶点数|p50 **68** / p90 **256** / max **6,072**|

> 结论：预测边显著更稠密、噪声潜在更大——**需阈值/Top-K 过滤**。

#### E｜方剂（Formula）→ 靶点 可用性

|指标|数值|
|---|---|
|formulas_total|**8,977**|
|至少可达 1 个靶点的方剂|**8,731（97.3%）**|
|每方剂可达靶点数|min **5** / p50 **12,647** / p90 **13,276** / max **14,026**|

> 结论：方剂层高度连通，但**极稠密**，聚合前需 **top-K 截断**。

#### F｜监督样本 (Disease, Formula)（来自 D5→CPM→Formula）

|指标|数值|
|---|---|
|n_pairs|**69,431**|
|diseases（参与监督）|**2,758**|
|formulas（参与监督）|**4,535**|
|有分子支撑的监督对|**66,754（≈96%）**|

> 结论：监督样本**规模充足**；建议先用 **66,754** 条“有分子支撑”的对进行训练，其余作为冷启动评估集。

#### 补充：全局大边计数（你先前校验过）

- `TARGETS_PREDICTED` **7,551,198** 条
    
- `ASSOCIATED_WITH`（_Diseases-MeSH_）**10,127,604** 条；（_Diseases-CUI_）**46,273** 条
    
- `INTERACTS_WITH`（PPI）**6,879,008** 条
    
- `Chemical.sources`（D14 溯源属性不为空的化合物）**68,448** 个
    

---

### 1.3 图谱实体与关系概览（当前具备）

`Disease -(TREATED_BY)-> CPM <-(STANDARDIZED_FROM)- Formula CPM/Formula -(CONTAINS)-> Herb -(HAS_COMPONENT)-> Chemical Chemical -(TARGETS / TARGETS_PREDICTED)-> Target Target -(ASSOCIATED_WITH {source: 'Diseases-MeSH' | 'Diseases-CUI'})-> Disease Target -(INTERACTS_WITH)-> Target      # PPI Herb -(HAS_PROPERTY)-> Property        # D7: 性/味/归经/类别 Chemical.sources = [Source:SourceID...]# D14 溯源 Target.sequence_aa / seq_len           # D17 序列属性`

---

## 2) 当前议定的模型架构（**双塔对比学习 v1.0**）

> 该架构与参数**依据 ABCDEF 数据画像**而定，旨在解决“疾病/方剂侧超稠密”与“SD1 噪声更大”的现实。  
> **特别说明**：以下阈值/Top-K 是我们的**工程口径**，**不是TCMMKG论文原文设计**；我们已明确区分，避免再次出现幻觉。

### 2.1 设计动机（为何修改初版）

- **数据可用性结论**：
    
    - 疾病侧：仅 ~**9.5%** 疾病有分子证据，但这些疾病**靶点极度稠密**（B：p50≈2.3k，p90≈17.6k）。
        
    - 方剂侧：**97.3%** 可落靶，且每方剂靶点**极稠密**（E：p50≈12.6k）。
        
    - 预测边（SD1）：**中位 68** 靶点/化合物（D），**显著>实验**。
        
- **潜在风险**：平均池化会被稠密节点“淹没”，预测边会“注水”信号。
    
- **因此**：我们采用“**先验权重 + 注意力微调**”与“**严格的阈值/Top-K 截断**”，把学习重点放在**微调重要性**，而非“从零学习谁重要”。
    

### 2.2 预处理口径（工程选择）

- **疾病侧（稠密截断+重加权）**
    
    - 保留疾病侧靶点 **top-K_d = 1000**（按来源/证据强度与全局稀有度排序）。
        
    - 对全局高频靶点做 **逆频重加权**（例如 `1/log(1+freq)`），避免“公共靶点”主导。
        
- **化合物→靶点（SD1 降噪）**
    
    - 预测边：**pKi ≥ 6.0**（或）**per-chemical top-K_c = 10–20**；
        
    - 实验边：全保留。
        
- **方剂侧聚合**
    
    - 合并后方剂侧靶点再做 **top-K_f = 3000**，控制复杂度与过拟合。
        
    - Herb 级用 `dosage_ratio` 做 **softmax(温度 η)** 形成剂量先验。
        

> ⚠️ 以上 **K_d/K_f/K_c 与 pKi 阈值**均为**我们据 A–E 统计制定的工程口径**，用于首版模型稳定训练；可在后续灵敏度实验（5.0/5.5/6.0；K 的不同取值）里再对比。

### 2.3 两塔编码（对齐到“靶点语义空间”）

- **靶点嵌入** et∈R256\mathbf{e}_t \in \mathbb{R}^{256}et​∈R256：可学习；未来可拼接 PPI/node2vec 或序列嵌入（可选）。
    
- **疾病塔**：输入为截断加权后的 {(t,wd(t))}\{(t, w_d(t))\}{(t,wd​(t))}，采用“**先验 logits + 注意力微调**”池化，输出 z^d\hat{\mathbf{z}}_dz^d​。
    
- **方剂塔**：
    
    - 化合物的药理画像：对（实验/预测过滤后的）靶点加权池化得到 vc\mathbf{v}_cvc​；
        
    - 化合物的理化画像（D12）：pc\mathbf{p}_cpc​ 与 vc\mathbf{v}_cvc​ 并联后统一投影；
        
    - Herb 级注意力聚合；再以**剂量先验**+注意力聚合到方剂向量 z^f\hat{\mathbf{z}}_fz^f​。
        

> 统一思想：**一切投影到靶点空间，再做加权/注意力聚合**，确保两塔可比较。

### 2.4 训练与损失（对比学习）

- **相似度**：余弦 s(d,f)=z^d⊤z^fs(d,f) = \hat{\mathbf{z}}_d^\top \hat{\mathbf{z}}_fs(d,f)=z^d⊤​z^f​。
    
- **损失**：InfoNCE（对称 in-batch 负样本），**温度 τ≈0.1**（工程选择）；  
    先使用 in-batch negatives，稳定后引入“热门方剂难负样本”。
    
- **训练集**：优先使用 **66,754** 条“有分子支撑”的 (Disease, Formula) 正样本。
    
- **验证**：按疾病划分；另保留“无分子信息的疾病”作**冷启动评估**。
    

### 2.5 推理与可解释性（本阶段只定思路）

- **召回-精排两段式**（可选）：先用简单重叠/点积召回 top-M，再用双塔精排；或直接全量精排。
    
- **可解释回溯**：保留疾病侧 αd,t\alpha_{d,t}αd,t​、方剂侧 βf,h\beta_{f,h}βf,h​ 与化合物→靶点权重，回溯  
    `Disease → Formula → Herb → Chemical → Target → Disease` 的 Top-k 证据链。
    
- **本阶段不展开细节**，等首版训练稳定后落地。
    

---

## 3) 口径声明与后续计划

- **DOID 路径**：**未导入**；当前“疾病→靶点”证据**主要来自 MeSH 与少量 CUI**。
    
- **阈值与 Top-K**：**属于本研究工程口径**；已基于你执行的 A–E 统计与可计算性确定，后续可做灵敏度曲线。
    
- **首版目标**：以 **66,754** 条“有分子支撑”的监督对为训练主集，跑通双塔 + InfoNCE 的端到端流程，验证 Recall@K/NDCG@K 上的可学性与收敛。
    
- **扩展（后续再议）**：
    
    - 加入 PPI/序列嵌入；
        
    - 冷启动编码器（ICD 文本/层级传播）；
        
    - 更细的权重学习与多任务（如通路富集对齐）。
        

---

### 一句话结论

> **数据**：分子层高质量，疾病/方剂侧极稠密但可控；监督规模充足（≈6.7 万对）。  
> **架构**：以“先验+注意力”的双塔为核心，配合 **pKi 阈值与 Top-K 截断**，优先解决稠密与噪声两大痛点，确保首版可训练、可收敛、可解释。

——以上即为可直接交接给“新对话/新模型”的**完整现状与架构蓝图**。