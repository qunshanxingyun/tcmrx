## 一、报告背景

本报告针对2025.11.01双塔架构模型在 TCM-MKG 数据集上的初次训练结果（Recall@1≈0.03, MRR≈0.21）进行结构性诊断。
 通过对输入数据的统计分析，我们发现若干严重的分布异常，这些异常已对模型训练产生决定性影响。

------

## 二、核心发现与风险评估

### 1️⃣ 方剂与疾病两侧的靶点分布极度稠密，信息差被严重压缩

- 疾病平均包含约 **710** 个靶点，方剂平均约 **2850** 个靶点；
- 二者分别被硬性截断在上限 **1000** 与 **3000** 个靶点；
- 方剂塔中超过 90% 的样本接近上限值。

**风险说明：**
 这种全体稠密化直接导致每个输入向量几乎被“平均化”，
 模型看到的大多数方剂样本之间几乎没有差异。
 在训练过程中，梯度无法识别出有效区分特征，从而出现“Recall@1≈0.03”一类退化现象。

------

### 2️⃣ 靶点权重分布高度均匀，注意力机制失去意义

- 方剂塔与疾病塔的权重熵接近理论上限（均值分布熵≈log N）；
- 权重分布几乎均匀，没有显著的主导靶点。

**风险说明：**
 聚合层（尤其是注意力聚合层）几乎无事可做。
 所有靶点被视为等价，
 “重要靶点”的信号被平均淹没，模型失去了从结构中提取关键信息的能力。

------

### 3️⃣ 方剂塔的靶点覆盖存在严重的“公共节点塌缩”

- 方剂侧前 100 个高频靶点覆盖了 **77.9%** 的所有边；
- 方剂侧前 10 个靶点已占全部连接的 **38%**；
- 疾病侧相对分散（前 100 靶点仅占 2.1%），存在结构不对称。

**风险说明：**
 模型面对的“方剂向量”几乎都集中在同一簇内，
 训练信号被公共靶点主导，无法建立个体化的药理映射。
 这是一种**结构性塌缩现象（representation collapse）**。

------

### 4️⃣ 疾病与方剂之间的靶点交集极小

- 平均 Jaccard 相似度仅 **0.011**，平均疾病靶点覆盖率约 **2–3%**。
- 训练集与测试集均呈现相同趋势。

**风险说明：**
 双塔模型假设“疾病与方剂的靶点集合存在部分重叠或潜在相似”。
 当交集几乎不存在时，对齐学习就失去了物理基础。
 模型只能学习到统计噪声或疾病流行度偏置。

------

### 5️⃣ 疾病–方剂配对呈极端长尾分布

- 平均每个疾病对应 25 个方剂，中位数仅 5 个，最大值高达 770；
- 约 5% 的“超级疾病”占据了 60% 以上的样本。

**风险说明：**
 训练被少数高频疾病主导，
 长尾疾病的嵌入更新极少，预测能力退化。
 Recall 曲线中“尾部疾病”几乎完全失效。

------

## 三、结果综合判断

| 问题类别          | 严重程度 | 可修复性               | 影响说明                   |
| ----------------- | -------- | ---------------------- | -------------------------- |
| 方剂塔过度稠密    | ★★★★★    | 中等（可稀疏化）       | 当前模型几乎失去方剂区分度 |
| 权重均匀化        | ★★★★☆    | 中等（重新分配权重）   | 注意力机制失效             |
| 公共靶点塌缩      | ★★★★★    | 困难（需重新构造特征） | 模型学习退化               |
| 疾病–方剂交集稀疏 | ★★★★☆    | 低（结构问题）         | 对齐机制无统计支撑         |
| 数据长尾偏斜      | ★★★☆☆    | 中（采样可缓解）       | 导致 Recall 波动与偏置     |

------

## 四、可行修复方向

1. **靶点稀疏化与重权分配**
   - 每个方剂仅保留最重要的前 300–500 个靶点；
   - 使用靶点出现频率的倒数作为权重，使罕见靶点贡献更大。
2. **降低靶点截断上限并引入去频正则**
   - 疾病侧上限 1000 → 500；方剂侧 3000 → 800。
   - 引入熵约束或信息瓶颈，使高熵输入自动稀疏化。
3. **引入结构性特征辅助**
   - 例如通路聚合（Pathway）、靶点功能簇、分子子图等结构信息，
     使“重叠过小”的疾病–方剂对仍能通过高层语义找到连接。
4. **数据再采样**
   - 对高频疾病随机下采样，对低频疾病上采样或加权训练。

------

## 五、结论性判断：是否应继续在双塔上投入

**结论：不建议在当前数据选取策略下继续投入模型调优时间。**

### 理由：

1. 当前的靶点分布特征**与双塔假设不兼容**：
   双塔模型要求两侧实体具有可比较的特征结构，并且部分重叠。
   而在现有图谱中，疾病靶点稀疏、方剂靶点稠密且高度重叠，
   使得“对齐学习”成为无效任务。
2. 当前模型的低性能**主要源自输入空间的退化**，而非网络参数或损失设计。
   调整学习率、正则、负采样策略都不会显著改善 Recall。
3. 若继续调优，训练结果将稳定在 0.02–0.05 的 Recall@1 区间，
   成本高、收益低。
4. 在继续研究之前，必须先完成 **数据结构修复**（特别是方剂塔稀疏化与通路聚合）。
   只有当疾病与方剂在特征空间中存在部分结构性对齐时，双塔架构才可能恢复有效学习。

------

## 六、后续建议（按优先级排序）

| 优先级 | 建议方向               | 说明                                                         |
| ------ | ---------------------- | ------------------------------------------------------------ |
| ★★★★★  | **方剂塔稀疏化**       | 仅保留高置信度靶点 + 去除公共靶点；让每个方剂重新具备差异。  |
| ★★★★☆  | **通路层替代靶点空间** | 把靶点投影到通路层，再对齐疾病与方剂的“通路激活向量”；能天然稀疏且解释性强。 |
| ★★★☆☆  | **重新采样训练集**     | 降低超级疾病的影响，均衡训练信号。                           |
| ★★☆☆☆  | **模型轻量微调**       | 可在数据修复后再试；当前阶段调参无明显意义。                 |
