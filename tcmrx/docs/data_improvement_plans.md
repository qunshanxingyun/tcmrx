## **目标**

在不改变现有双塔代码结构的前提下，通过清洗和重新采样数据，让模型输入重新满足三个基本条件：

1. **方剂与疾病两侧的特征分布可区分**；
2. **聚合后的靶点不再被少数高频节点主导**；
3. **疾病–方剂对之间存在可学习的重叠或间接关联。**

------

## **步骤 1｜稀疏化方剂塔（最关键一步）**

### 🎯 目标

削减方剂靶点数量，使其重新具备差异性，避免“全部方剂几乎一样”的情况。

### 💡 实现方式（推荐方案）

在聚合阶段（或生成中间缓存文件时）加入以下过滤规则：

1. **根据置信度过滤靶点**
   - 保留所有实验靶点；
   - 对预测靶点，仅保留 `pKi ≥ 6` 或者对每个化合物保留 Top-10~20 个预测靶点。
2. **控制方剂最大靶点数**
   - 每个方剂最终最多保留 **800 个靶点**（包含实验+预测），超过部分按权重截断；
   - 若不足 200 个，可补少量相似化合物的靶点（不推荐强行补齐）。
3. **惩罚高频靶点**
   - 计算每个靶点在所有方剂中的出现次数；
   - 对出现频率前 100 的“公共靶点”，将其权重乘以 0.1 或直接剔除。
4. **重新计算靶点权重**
   - 靶点权重 = `dosage_ratio × confidence × inverse_frequency`；
   - 这样高剂量、高置信度、稀有靶点的影响更大。

### ⚙️ 实现代价

- 可直接修改现有数据加载模块或预处理脚本；
- 无需改动模型代码；
- 预计工作量：**1 天以内**。

------

## **步骤 2｜平衡训练集（防止“超级疾病”主导）**

### 🎯 目标

减少训练集中由少数高频疾病主导的样本偏置，使模型能学到长尾疾病的有效信号。

### 💡 实现方式

1. **按疾病出现频率分桶**
   - 将疾病按训练集中出现次数分为三类：高频（>200对）、中频（20–200）、低频（<20）。
2. **分层采样训练对**
   - 对高频疾病，只保留其方剂配对的最多 100 条；
   - 对中频疾病全保留；
   - 对低频疾病在采样时重复 2–3 次，以增加训练信号。
3. **保证验证集/测试集分布不变**
   - 仅对训练集生效。

### ⚙️ 实现代价

- 修改训练数据加载器的采样逻辑；
- 不影响现有模型结构；
- 预计工作量：**0.5–1 天**。

------

## **步骤 3｜最小通路聚合（降低维度、增强语义）**

### 🎯 目标

让疾病与方剂拥有**共同的中间语义空间**（通路），即使靶点交集稀疏，模型仍能在“通路层”建立联系。

### 💡 实现方式（最小版本）

1. **利用现有 D12 数据**
   - 读取每个化合物的 Pathway1/2/3 字段；
   - 统一命名（全部小写、去空格、去重复）。
2. **建立简单映射**
   - `(:Chemical)-[:PARTICIPATES_IN]->(:Pathway)`；
   - 每个化合物可对应多个通路节点。
3. **通路特征聚合**
   - 在方剂侧：Herb → Chemical → Pathway；
   - 在疾病侧：Disease → Target → Chemical（如果有）→ Pathway；
   - 最终得到方剂和疾病的通路激活向量（500 维以内）。
4. **使用现有代码并行计算**
   - 不必改动网络层结构，可以把通路向量拼接到靶点向量上再输入模型。

### ⚙️ 实现代价

- 只需编写一个脚本生成化合物→通路映射文件；
- 不影响主训练流程；
- 预计工作量：**1–2 天**。