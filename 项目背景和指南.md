# 一、项目上下文（背景与目标）

## 背景

* 我们已完成知识图谱相关数据的导入与一致性检查。当前手上具备的实体/关系规模与连通性画像如下：疾病 17,692；靶点 19,700；化合物 125,187；方剂（Formula）8,977；(Disease, Formula) 监督对 69,431（其中 **≈96%** 有分子支撑 66,754 对）。疾病侧与方剂侧的“可达靶点集合”极为稠密（例如疾病侧 p50≈2,347 个靶点，方剂侧 p50≈12,647 个靶点），因此**训练前必须进行 Top-K 截断与加权**以控制噪声与计算复杂度。

## 目标

* 构建一个**基于疾病的方剂推荐模型**：输入 ICD-11 疾病类别，输出相似度最高的一组方剂（Formula），并可在向量空间中进行对比学习训练与评估。
* **首版训练采用双塔对比学习**：将“疾病侧的靶点集合”和“方剂侧经 Herb→Chemical→Target 聚合得到的靶点集合”分别编码为向量，对齐在**靶点语义空间**中，用 InfoNCE 损失进行端到端训练。

---

# 二、数据总览与文件说明（严格按提供的列名与含义）

本项目仅依赖**TSV 文件**。以下列名与含义均来自《知识图谱数据文件列名说明》，**不得改名或臆测**。

## 2.1 与“方剂侧”相关的数据

* **D2\_Chinese\_patent\_medicine.tsv（中成药基础）**：`CPM_ID`、`Chinese_patent_medicine` 等。
* **D4\_CPM\_CHP.tsv（中成药↔中药饮片）**：`CPM_ID`, `CHP_ID`, `Dosage_ratio`（用于方剂内部药材权重/剂量先验）。
* **D6\_Chinese\_herbal\_pieces.tsv（饮片主表）**：`CHP_ID`, `Chinese_herbal_pieces` 等。
* **D9\_CHP\_InChIKey.tsv（饮片↔化合物）**：`CHP_ID`, `InChIKey`, `Source`。
* **D12\_InChIKey.tsv（化合物理化/结构特征）**：`InChIKey`, `SMILES`, `Molecular_Formula`, `QED`, `MolWt`, `TPSA`, `MolLogP`, …（若需将理化特征拼接到化合物表征）。
* **SD1\_predicted\_InChIKey\_EntrezID.tsv（化合物→靶点预测亲和力）**：`InChIKey`, `EntrezID`, `predicted_binding_affinity`。

> 备注：如果存在实验靶点边（非 SD1 预测），在你的资料中是通过 InChIKey→EntrezID 的映射文件族（如 D13 等）实现；本指南默认**优先保留实验边**，并对 SD1 预测边做阈值/Top-K 过滤（见 § 四）。若当前仅有 SD1，则仅使用 SD1。

## 2.2 与“疾病侧”相关的数据

* **D18\_ICD11.tsv（ICD-11 疾病基础）**：`ICD11_code`, `English_term`, `Chinese_term`, `ClassKind` 等（用于识别叶节点疾病类别）。
* **D19\_ICD11\_CUI.tsv（ICD-11↔CUI）**：`ICD11_code`, `CUI`。
* **D20\_ICD11\_MeSH.tsv（ICD-11↔MeSH）**：`ICD11_code`, `MeSH`。
* **D22\_CUI\_targets.tsv（CUI↔靶点 EntrezID）**：`CUI`, `EntrezID`。
* **D23\_MeSH\_targets.tsv（MeSH↔靶点 EntrezID）**：`MeSH`, `EntrezID`。

> 依据**已验证的数据现状**，疾病→靶点的证据**主要来自 MeSH 与少量 CUI**，DOID 路径当前未用（A 检查 `n_doid=0`）。因此疾病侧靶点集合由 D19/D20 通过 D22/D23 聚合得到。

## 2.3 与“靶点/蛋白层”相关的数据

* **D17\_Target\_Symbol\_Mapping.tsv（靶点序列与基因符号映射）**：包含 `UniProtID`, `GeneSymbol`, `EntrezID`, `Sequence`（我们已将序列属性汇入 `Target`，覆盖率 100%）。**首版模型仅用靶点ID做可学习嵌入**，序列/PPI 可留作后续增强。
* **D16\_Protein\_protein\_interactions.tsv（PPI）**：`EntrezID1`, `EntrezID2`。同样**首版不引入**，后续可扩展。

---

# 三、数据处理与预处理口径（严格按已确定工程口径）

> 目的：将 TSV 直接在内存中处理为**两类聚合对象**：
> ① “疾病→靶点集合（含可选权重）”；② “方剂（CPM/Formula）→靶点集合（含剂量与权重线索）”。
> 这两个集合是双塔模型的**原生输入**。

## 3.1 构建“方剂→靶点集合”

1. **CPM→CHP（方剂内药材与剂量）**
   * 读取 D4：使用 `CPM_ID`, `CHP_ID`, `Dosage_ratio`。此处的 `Dosage_ratio` 作为**剂量先验**的原始来源。
2. **CHP→Chemical（药材到化合物）**
   * 读取 D9：以 `CHP_ID` 关联 `InChIKey`。可在后续拼接 D12 的理化特征列（如 `QED`, `MolWt`, `TPSA` 等）形成化合物侧的“理化画像”。
3. **Chemical→Target（化合物到靶点）**
   * **SD1 预测亲和力**：读取 SD1（`InChIKey`, `EntrezID`, `predicted_binding_affinity`），按以下**既定阈值**过滤：
     * 全局阈值 `pKi ≥ 6.0`；**或** 每化合物 `TopK_c = 10–20`（二者取其一或合并使用，取决于实验设计）。
   * **若有实验边**（如另有 InChIKey↔EntrezID 的实验来源），实验边**全部保留**，与 SD1 合并后去重。
4. **CPM→Target（逐级聚合并截断）**
   * 将 `CPM_ID` 通过 `CHP_ID → InChIKey → EntrezID` 聚合到**方剂的靶点集合**。
   * **剂量先验**：对同一 CPM 内来自 D4 的 `Dosage_ratio` 做 **softmax(温度 η)**，作为 Herb→Chemical→Target 聚合时的**初始权重**。
   * **方剂侧 Top-K 截断**：对最终“方剂→靶点集合”进行 `TopK_f = 3000` 截断（依据重要性排序，排序依据见 §3.3）。

> 现状指标：8,977 个方剂中，至少可达 1 个靶点的有 8,731（97.3%）；每方剂可达靶点中位数约 12,647，p90≈13,276，max≈14,026，故**Top-K 截断是必要的**。

## 3.2 构建“疾病→靶点集合”

1. **ICD-11→（CUI/MeSH）**
   * 读取 D19 与 D20，拿到 `ICD11_code` 对应的 `CUI` 与 `MeSH`。
2. **（CUI/MeSH）→Target**
   * 读取 D22（`CUI`, `EntrezID`）与 D23（`MeSH`, `EntrezID`），将同一 `ICD11_code` 的 CUI/MeSH 所映射到的 `EntrezID` 进行**并集**（去重）。
3. **疾病侧 Top-K 截断与重加权**
   * 对“疾病→靶点集合”执行 `TopK_d = 1000` 的截断（排序依据见 §3.3）。
   * 对**全局高频靶点**采用**逆频重加权**（例如 `w_t = 1 / log(1 + freq(t))`），缓解“公共靶点”主导效应。

> 现状指标：有分子证据的疾病 ≈1,684（约 9.5%）；这些疾病的靶点分布**极度稠密**（p50≈2,347；p90≈17,639；max≈19,252），因此**Top-K 与逆频重加权**是既定工程口径。

## 3.3 截断与排序的统一依据（重要性次序）

当我们对疾病侧或方剂侧做 Top-K 截断时，需要一种**统一的排序**。按照既定思路：

* **化合物→靶点层**：
  * 实验边优先；预测边按 `predicted_binding_affinity` 由高到低排序。
* **Herb/Formula 聚合层**：
  * 使用\*\*剂量先验（`Dosage_ratio` 的 softmax）\*\*作为初始权重，再由注意力模块微调（见 § 四）。
* **疾病/方剂→靶点集合层**：
  * 采用**逆频重加权**抑制全局高频靶点，构造加权得分用于 Top-K。

---

# 四、核心算法：双塔对比学习（实现口径）

> **统一思想**：一切表征均投影到**靶点嵌入空间**，再做加权/注意力聚合。**不引入超大序列或PPI编码**作为首版前置条件，以保证可训练性与可复现性。

## 4.1 嵌入与表示

* **靶点嵌入**`e_t ∈ ℝ^256`：可学习向量（后续可拼接 PPI/序列，但**首版不启用**）。
* **疾病塔输入**：疾病 `d` 的“靶点集合” `{(t, w_d(t))}`，`w_d(t)` 来自 §3 的逆频重加权/Top-K 后的权重。
* **方剂塔输入**：方剂 `f` 的“靶点集合” `{(t, w_f(t))}`，`w_f(t)` 综合了剂量先验与化合物→靶点层的权重（实验/预测强度）。

## 4.2 聚合器

* **先验加权求和（WeightedSum）**：
  `z = Norm( Σ_t w(t) · e_t )`，其中 `Norm` 为 L2 归一，确保与余弦相似度匹配。
* **注意力微调（Attention）**：
  在先验权重基础上，用单头注意力对 `{e_t}` 打分得到 `α_t`，再与先验权重合成最终权重：`w’(t) = α_t · w(t)`，再做加权求和与 L2 归一。**注意力仅作微调，不替代先验。**

## 4.3 相似度与损失

* **相似度**：疾病向量 `z_d` 与方剂向量 `z_f` 的**余弦相似度**。
* **损失**：**InfoNCE**（对称 in-batch 负样本），温度 `τ ≈ 0.1`。训练时先使用 in-batch negatives，稳定后可加入“热门方剂难负样本”（同批或额外采样）。

## 4.4 训练与数据划分

* **训练集**：优先使用**有分子支撑的 66,754 条** (Disease, Formula) 正样本（从 D5 的 `CPM_ID, ICD11_code` 监督对中过滤得到）。剩余对可作对照或冷启动评估。
* **划分策略**：按疾病划分训练/验证/测试；另外保留“无分子信息的疾病”用于**冷启动评估**。
* **评估指标**：Recall@K、NDCG@K。

---

# 五、端到端流水线（仅基于 TSV，在内存中完成）

> 下述步骤**必须逐条执行并做断言**。任一表**缺列或为空**，立即报错并终止（指出具体文件和缺失列名）。

1. **读取与校验**
   * 读取 D2/D4/D6/D9/D12（方剂侧），D18/D19/D20/D22/D23（疾病侧），SD1（化合物→靶点预测）。对每个表检查**必需列**是否存在（`schema_map` 为唯一依据）。
2. **构建索引集（ID→int）**
   * 为 `ICD11_code`、`CPM_ID`、`CHP_ID`、`InChIKey`、`EntrezID` 建立稳定索引（仅内存，不落盘）。用于 Embedding 对齐与稀疏聚合。
3. **方剂侧聚合**
   * D4：得到 `CPM_ID → {(CHP_ID, Dosage_ratio)}`。
   * D9：`CHP_ID → {InChIKey}`，并用 D12 补齐理化特征（如需）。
   * SD1：`InChIKey → {(EntrezID, predicted_binding_affinity)}`；执行 `pKi ≥ 6.0` 或 `per-chemical TopK_c` 过滤；与实验边（若有）合并去重。
   * 聚合得到 `CPM_ID → {EntrezID}`，并将 `Dosage_ratio` 经过 **softmax(η)** 传导为初始权重。最后施加 `TopK_f = 3000`。
4. **疾病侧聚合**
   * D19/D20：`ICD11_code → {CUI, MeSH}`。
   * D22/D23：`{CUI, MeSH} → {EntrezID}`；对同一疾病取并集（去重）。
   * 对“疾病→靶点集合”执行**逆频重加权**与 `TopK_d = 1000`。
5. **监督对与样本构建**
   * D5：读取 `CPM_ID, ICD11_code`，形成 (Disease, Formula) 正样本集合。
   * 与步骤 3/4 的两侧集合对齐，去除任一侧无靶点的监督对；优先保留**有分子支撑**的 66,754 对用于训练。
6. **批生成与训练**
   * 以“集合型输入 + 权重”的方式喂给模型（疾病塔/方剂塔分别聚合到向量），计算对称 InfoNCE。
   * 每 N 步在验证集上计算 Recall@K/NDCG@K，跟踪收敛。
7. **最小健全性检查（sanity）**
   * 从每个 TSV 取前若干行，贯穿整链：能拿到**至少 1 条**疾病–方剂相似度结果，即视为打通。

---

# 六、关键风险与强制断言

* **字段名漂移**：所有读取/连接函数**必须**以 `schema_map` 的列名常量做校验；一旦不匹配**立即报错**（表名、缺列名）。
* **极端稠密**：若单个疾病或方剂的靶点集合超出内存上限，必须执行既定 `TopK_d/TopK_f`，且在日志中记录截断比例。
* **预测边噪声**：SD1 过滤为**强约束**（`pKi ≥ 6.0` 或 `TopK_c`）；不可跳过，否则会显著稀释信号。
* **监督对泄漏**：训练/验证按疾病划分；构建监督对时，严格以划分后的疾病集合为准，避免同病跨集。

---

# 七、已确定且不可随意变更的工程口径（首版）

* **TopK\_d = 1000（疾病侧）**；**TopK\_f = 3000（方剂侧）**；**TopK\_c = 10–20（每化合物预测靶点）**；**pKi ≥ 6.0（SD1 过滤阈值）**。
* **靶点嵌入维度 256**，余弦相似度 + **InfoNCE（τ≈0.1）**，优先使用 in-batch negatives。
* **不落盘中间格式**（Parquet/NPZ 等非必要产物），**只读 TSV，在内存处理**。
* **不引入复杂编码器**（序列/PPI/图网络）作为首版依赖，等首版稳定后再增量扩展。
